<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Wizard -->
    <record id="view_informe_de_caja_wizard_form" model="ir.ui.view">
        <field name="name">informe.de.caja.wizard.form</field>
        <field name="model">informe_de_caja_wizard</field>
        <field name="arch" type="xml">
            <form string="Informe de caja diario">
                <group>
                    <field name="date"/>
                    <field name="user_id" readonly="1" options="{'no_open': True}"/>
                    <field name="categoria" attrs="{'readonly':[('is_adm','=',False)]}"/>
                    <field name="is_adm" invisible="1"/>
                </group>
                <footer>
                    <button name="action_print" type="object" string="Imprimir informe" class="btn-primary"/>
                    <button string="Cancelar" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Acción Wizard -->
    <record id="action_informe_de_caja_wizard" model="ir.actions.act_window">
        <field name="name">Informe de caja diario</field>
        <field name="res_model">informe_de_caja_wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="view_id" ref="view_informe_de_caja_wizard_form"/>
    </record>

    <!-- Menú -->
    <menuitem id="menu_informe_de_caja_wizard"
              name="Informe de caja diario"
              parent="account.menu_finance_receivables"
              action="action_informe_de_caja_wizard"
              sequence="95"/>

        
        <menuitem id="menu_informe_de_caja_wizard_2"
              name="Informe de caja diario"
              parent="sale.sale_order_menu"
              action="action_informe_de_caja_wizard"
              sequence="95"/>

    <!-- Acción de reporte -->
    <record id="report_caja" model="ir.actions.report">
        <field name="name">Informe de caja</field>
        <field name="model">informe_de_caja_wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">Insumar_Estadopagos.informe_de_caja</field>
        <field name="report_file">Insumar_Estadopagos.informe_de_caja</field>
        <field name="print_report_name">'informe_caja_' + (object.date and object.date.strftime('%Y%m%d') or '')</field>
    </record>

    <!-- Template -->
    <template id="informe_de_caja">
        <t t-call="web.html_container">

            <t t-call="web.basic_layout">

                <style type="text/css">
                    /* Tabla principal */
                    .o_main_table tbody td { font-size: 11px; }
                    .o_main_table th, .o_main_table td { text-align: center; }
                    .o_main_table th.col-money, .o_main_table td.col-money {
                        width: 90px; white-space: nowrap; box-sizing: border-box; text-align: right;
                    }
                    .section-row td { font-weight: bold; background: #f0f0f0; }
                    .subtotal-row td, .total-row td { font-weight: bold; }

                    /* Resúmenes lado a lado (compatibles con wkhtmltopdf) */
                    .summary-layout { width: 100%; border-collapse: collapse; margin-top: 12px; }
                    .summary-layout td { vertical-align: top; width: 50%; }

                    .summary-table { border-collapse: collapse; width: 100%; }
                    .summary-table th { text-align: center; font-size: 13px; }
                    .summary-table td { font-size: 11px; }
                    .summary-table td.label { text-align: center; }
                    .summary-table td.col-money { text-align: right; width: 140px; }
                    .summary-table tfoot td { font-weight: bold; }
                </style>
                <div class="header">
                    <div style="text-align:center; font-weight:700; font-size:17px;">
                        Informe de caja
                    </div>
                    <div style="text-align:center; font-size:14px; margin-top:2px;">
                        Caja: <t t-esc="seleccion_name"/> — Fecha: <t t-esc="date"/>
                    </div>
                </div>
                <div class="page">
                    <!-- Contexto -->
                    <t t-set="invoice_rows_day" t-value="invoice_rows_day or []"/>
                    <t t-set="abonos_rows" t-value="abonos_rows or []"/>
                    <t t-set="refund_rows" t-value="refund_rows or []"/>

                    <t t-set="inv_day_subtotals" t-value="inv_day_subtotals or {}"/>
                    <t t-set="abonos_subtotals" t-value="abonos_subtotals or {}"/>
                    <t t-set="ref_subtotals" t-value="ref_subtotals or {}"/>
                    <t t-set="grand_totals" t-value="grand_totals or {}"/>
                    <t t-set="method_totals" t-value="method_totals or {}"/>
                    <t t-set="credit_total" t-value="credit_total or 0.0"/>

                    <t t-set="fecha" t-value="date"/>
                    <t t-set="seleccion_name" t-value="seleccion_name"/>

                    <div style="margin-bottom:12px;">
                        <span><strong>Fecha:</strong> <t t-esc="fecha"/></span>
                        <span style="margin-left:20px;"><strong>Selección:</strong> <t t-esc="seleccion_name"/></span>
                    </div>

                    <!-- Tabla principal -->
                    <table class="table table-sm o_main_table" style="width:100%; border-collapse:collapse;" border="1">
                        <colgroup>
                            <col/><col/><col/>
                            <col style="width:90px"/><col style="width:90px"/><col style="width:90px"/>
                            <col style="width:90px"/><col style="width:90px"/><col style="width:90px"/>
                            <col/>
                        </colgroup>
                        <thead>
                            <tr tyle="font-size:14px;">
                                <th></th>
                                <th>Documento</th>
                                <th>Fecha Factura</th>
                                <th class="col-money">Monto</th>
                                <th class="col-money">Efectivo</th>
                                <th class="col-money">Tar-Deb</th>
                                <th class="col-money">Tra-Dep-NC</th>
                                <th class="col-money">Cheque</th>
                                <th class="col-money">Crédito</th>
                                <th>RUT</th>
                            </tr>
                        </thead>
                        <tbody>

                            <!-- FACTURAS DEL DÍA -->
                            <t t-if="invoice_rows_day">
                                <tr class="section-row"><td colspan="10">Facturas del Día</td></tr>
                                <tr t-foreach="invoice_rows_day" t-as="r">
                                    <td><t t-esc="r.get('sequence_prefix')"/></td>
                                    <td><t t-esc="r.get('sequence_number')"/></td>
                                    <td><t t-esc="r.get('date_invoice')"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('amount_total') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('efectivo') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('debito_tarjeta') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('transferencia_deposito') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('cheque') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('credito') or 0.0))"/></td>
                                    <td><t t-esc="r.get('document_number')"/></td>
                                </tr>
                                <tr class="subtotal-row">
                                    <td colspan="3">Subtotales</td>
                                    <td class="col-money"><t t-esc="('%.0f' % (inv_day_subtotals.get('amount_total', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (inv_day_subtotals.get('efectivo', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (inv_day_subtotals.get('debito_tarjeta', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (inv_day_subtotals.get('transferencia_deposito', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (inv_day_subtotals.get('cheque', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (inv_day_subtotals.get('credito', 0.0)))"/></td>
                                    <td></td>
                                </tr>
                            </t>

                            <!-- ABONOS -->
                            <t t-if="abonos_rows">
                                <tr class="section-row"><td colspan="10">Abonos</td></tr>
                                <tr t-foreach="abonos_rows" t-as="r">
                                    <td><t t-esc="r.get('sequence_prefix')"/></td>
                                    <td><t t-esc="r.get('sequence_number')"/></td>
                                    <td><t t-esc="r.get('date_invoice')"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('amount_total') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('efectivo') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('debito_tarjeta') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('transferencia_deposito') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('cheque') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('credito') or 0.0))"/></td>
                                    <td><t t-esc="r.get('document_number')"/></td>
                                </tr>
                                <tr class="subtotal-row">
                                    <td colspan="3">Subtotales</td>
                                    <td class="col-money"><t t-esc="('%.0f' % (abonos_subtotals.get('amount_total', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (abonos_subtotals.get('efectivo', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (abonos_subtotals.get('debito_tarjeta', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (abonos_subtotals.get('transferencia_deposito', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (abonos_subtotals.get('cheque', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (abonos_subtotals.get('credito', 0.0)))"/></td>
                                    <td></td>
                                </tr>
                            </t>

                            <!-- NOTAS DE CRÉDITO -->
                            <t t-if="refund_rows">
                                <tr class="section-row"><td colspan="10">Notas de crédito</td></tr>
                                <tr t-foreach="refund_rows" t-as="r">
                                    <td><t t-esc="r.get('sequence_prefix')"/></td>
                                    <td><t t-esc="r.get('sequence_number')"/></td>
                                    <td><t t-esc="r.get('date_invoice')"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('amount_total') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('efectivo') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('debito_tarjeta') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('transferencia_deposito') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('cheque') or 0.0))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (r.get('credito') or 0.0))"/></td>
                                    <td><t t-esc="r.get('document_number')"/></td>
                                </tr>
                                <tr class="subtotal-row">
                                    <td colspan="3">Subtotales</td>
                                    <td class="col-money"><t t-esc="('%.0f' % (ref_subtotals.get('amount_total', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (ref_subtotals.get('efectivo', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (ref_subtotals.get('debito_tarjeta', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (ref_subtotals.get('transferencia_deposito', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (ref_subtotals.get('cheque', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (ref_subtotals.get('credito', 0.0)))"/></td>
                                    <td></td>
                                </tr>
                            </t>

                            <!-- TOTALES -->
                            <t t-if="invoice_rows_day or abonos_rows or refund_rows">
                                <tr class="total-row">
                                    <td colspan="3">Totales</td>
                                    <td class="col-money"><t t-esc="('%.0f' % (grand_totals.get('amount_total', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (grand_totals.get('efectivo', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (grand_totals.get('debito_tarjeta', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (grand_totals.get('transferencia_deposito', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (grand_totals.get('cheque', 0.0)))"/></td>
                                    <td class="col-money"><t t-esc="('%.0f' % (grand_totals.get('credito', 0.0)))"/></td>
                                    <td></td>
                                </tr>
                            </t>
                        </tbody>
                    </table>

                    <!-- ======= RESÚMENES LADO A LADO (tabla contenedora de 2 columnas) ======= -->
                    <table class="summary-layout">
                        <tr>
                            <!-- Columna izquierda: Medios de pago individualizados + Crédito -->
                            <td>
                                <table class="table table-sm summary-table" border="1">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th class="col-money"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="label">Efectivo</td>
                                            <td class="col-money"><t t-esc="('%.0f' % (method_totals.get('efectivo', 0.0)))"/></td></tr>
                                        <tr><td class="label">Débito</td>
                                            <td class="col-money"><t t-esc="('%.0f' % (method_totals.get('debito', 0.0)))"/></td></tr>
                                        <tr><td class="label">Tarjeta de crédito</td>
                                            <td class="col-money"><t t-esc="('%.0f' % (method_totals.get('tarjeta', 0.0)))"/></td></tr>
                                        <tr><td class="label">Transferencia</td>
                                            <td class="col-money"><t t-esc="('%.0f' % (method_totals.get('transferencia', 0.0)))"/></td></tr>
                                        <tr><td class="label">Depósito</td>
                                            <td class="col-money"><t t-esc="('%.0f' % (method_totals.get('deposito', 0.0)))"/></td></tr>
                                        <tr><td class="label">Cheque</td>
                                            <td class="col-money"><t t-esc="('%.0f' % (method_totals.get('cheque', 0.0)))"/></td></tr>
                                        <!-- NUEVA FILA: Notas de crédito (monto negativo total de NC) -->
                                        <tr><td class="label">Notas de crédito</td>
                                            <td class="col-money"><t t-esc="('%.0f' % (ref_subtotals.get('amount_total', 0.0)))"/></td></tr>
                                        <tr><td class="label">Crédito</td>
                                            <td class="col-money"><t t-esc="('%.0f' % (credit_total or 0.0))"/></td></tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td class="label">Total</td>
                                            <td class="col-money">
                                                <t t-esc="('%.0f' % (
                                                    (method_totals.get('efectivo',0.0))
                                                    + (method_totals.get('debito',0.0))
                                                    + (method_totals.get('tarjeta',0.0))
                                                    + (method_totals.get('transferencia',0.0))
                                                    + (method_totals.get('deposito',0.0))
                                                    + (method_totals.get('cheque',0.0))
                                                    + (ref_subtotals.get('amount_total',0.0))
                                                    + (credit_total or 0.0)
                                                ))"/>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </td>

                            <!-- Columna derecha: Resumen de Abonos y Ventas del Día -->
                            <td>
                                <table class="table table-sm summary-table" border="1">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th class="col-money"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="label">Cobranzas o abonos</td>
                                            <td class="col-money">
                                                <t t-esc="('%.0f' % (
                                                    (abonos_subtotals.get('efectivo', 0.0))
                                                    + (abonos_subtotals.get('debito_tarjeta', 0.0))
                                                    + (abonos_subtotals.get('transferencia_deposito', 0.0))
                                                    + (abonos_subtotals.get('cheque', 0.0))
                                                ))"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="label">Ventas del Día</td>
                                            <td class="col-money">
                                                <t t-esc="('%.0f' % (
                                                    (inv_day_subtotals.get('amount_total', 0.0))
                                                    + (ref_subtotals.get('amount_total', 0.0))
                                                ))"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td class="label">Total</td>
                                            <td class="col-money">
                                                <t t-esc="('%.0f' % (
                                                    ((abonos_subtotals.get('efectivo', 0.0))
                                                    + (abonos_subtotals.get('debito_tarjeta', 0.0))
                                                    + (abonos_subtotals.get('transferencia_deposito', 0.0))
                                                    + (abonos_subtotals.get('cheque', 0.0)))
                                                    + ((inv_day_subtotals.get('amount_total', 0.0))
                                                    + (ref_subtotals.get('amount_total', 0.0)))
                                                ))"/>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </td>
                        </tr>
                    </table>

                </div>
            </t>
        </t>
    </template>

</odoo>
